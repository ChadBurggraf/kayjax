Kayjax={requests:[],maxCount:10,onStop:function(){},onSend:function(){},onStart:function(){},onReceive:function(){},appendQuery:function(d,c){},fireEndEvents:function(){if(typeof Kayjax.onReceive==="function"){try{Kayjax.onReceive()}catch(b){}}if(Kayjax.requests.length===0&&typeof Kayjax.onStop==="function"){try{Kayjax.onStop()}catch(b){}}},fireStartEvents:function(){if(Kayjax.requests.length===0&&typeof Kayjax.onStart==="function"){try{Kayjax.onStart()}catch(b){}}if(typeof Kayjax.onSend==="function"){try{Kayjax.onSend()}catch(b){}}},getReasonFromResponseCode:function(d){var c="OK";if(d>=300){if(d<400){c="The server attempted to redirect the request."}else{if(d<500){c="Invalid request or access denied."}else{if(d<600){c="Internal server error."}else{c="An unspecified HTTP error occurred."}}}}return c},prepareParameters:function(d){var f,e;if(typeof d!=="undefined"){for(f in d){if(d.hasOwnProperty(f)){e=Object.prototype.toString.call(d[f]);if(e==="[object Date]"){d[f]=d[f].toJson()}else{if(e==="[object Object]"){d[f]=Kayjax.prepareParameters(d[f])}}}}}return d},resolveUrl:function(d){var c=/^~\//;if(c.test(d)){if(typeof Kayjax.appPath==="string"){if(!/\/$/.test(Kayjax.appPath)){Kayjax.appPath=Kayjax.appPath+"/"}}else{Kayjax.appPath="/"}d=d.replace(c,Kayjax.appPath)}return d},request:function(c,d){},response:function(s,q){var p,v,i,o,t,u,r,e;i=[];u=s.getResponseHeader("X-Response-Id");r={success:true,reason:"",value:null};e=s.responseText||"";try{p=q(e.replaceJSONDates());r.success=p.success;r.reason=p.reason;r.value=p.value}catch(n){r.success=false;r.reason="An invalid response was received from the server."}if(!r.success&&!r.reason){r.reason=Kayjax.getReasonFromResponseCode(s.status)}for(o=0,t=Kayjax.requests.length;o<t;o++){if(Kayjax.requests[o].id.toString()===u){v=Kayjax.requests[o]}else{i.push(Kayjax.requests[o])}}Kayjax.requests=i;if(v){if(typeof v.callback==="function"){v.callback(r)}}else{if(!r.success){alert(r.reason)}}Kayjax.fireEndEvents();return r},update:function(f,d,e){},updateResponse:function(k,p){var l,n,j,o,i,m;l=k.getResponseHeader("X-Response-Id");j=[];o={success:true,reason:"",value:""};if(k.status!==0&&!(k.status>=200&&k.status<300)){o.success=false;o.reason=Kayjax.getReasonFromResponseCode(k.status)}else{o.value=k.responseText||""}for(i=0,m=Kayjax.requests.length;i<m;i++){if(Kayjax.requests[i].id.toString()===l){n=Kayjax.requests[i]}else{j.push(Kayjax.requests[i])}}Kayjax.requests=j;if(typeof p==="string"){p=document.getElementById(p)}p.innerHTML=o.value;if(n){if(typeof n.callback==="function"){n.callback(o)}}else{if(!o.success){alert(o.reason)}}Kayjax.fireEndEvents();return o}};Date.prototype.toJson=function(){return"/Date("+this.getTime()+")/"};Date.prototype.toShortDateString=function(h,i){h=h||"ymd";i=i||"-";var f=this.getFullYear();var j=this.getMonth()+1;var g=this.getDate();if(j<10){j="0"+j}if(g<10){g="0"+g}switch(h){case ("mdy"):return j+i+g+i+f;case ("dmy"):return g+i+j+i+f;default:return f+i+j+i+g}};Date.prototype.toShortTimeString=function(){var e=this.getHours();var f=this.getMinutes();var d=e<12?"AM":"PM";if(e==0){e=12}else{if(e>12){e-=12}}if(f<10){f="0"+f}return e+":"+f+" "+d};Date.fromJson=function(json){return typeof json==="string"&&json.isJsonDate()?eval(json.replace(String.DATE_EXP,"new Date($1)")):NaN};String.prototype.camel=function(){var b=/^([A-Z])/.exec(this);if(b){return b[1].toLowerCase()+this.substr(1)}else{return this}};String.prototype.getUrlScheme=function(){var d="";var c=/^([^:]+)/.exec(this);if(c&&c.length>1){d=c[1]}return d};String.prototype.isJsonDate=function(){return this.match(String.DATE_EXP)};String.prototype.replaceJSONDates=function(){return this.replace(/"\\\/Date\(([\d\-]+)\)\\\/"/g,"new Date($1)")};String.prototype.trim=function(){return this.replace(/^\s+/g,"").replace(/\s+$/g,"")};String.DATE_EXP=(/^\/Date\(([\d-]+)\)\/$/);Object.extend(Kayjax,{appendQuery:function(e,f){var d=(e.indexOf("?")>=0)?e.parseQuery():{};Object.extend(d,(Object.isString(f)?f.parseQuery():{}));f=Object.toQueryString(d);return e.split("?")[0]+(f?"?"+f:"")},request:function(url,options){if(Kayjax.requests.length>=Kayjax.maxCount){setTimeout(Kayjax.request.curry(url,options),100)}else{Kayjax.fireStartEvents();options=options||{};var queued,postBody,params,req;queued={id:Kayjax.requests.length,callback:options.callback||null};Kayjax.requests.push(queued);postBody=options.parameters?Object.toJSON(Kayjax.prepareParameters(options.parameters)):"";params={requestHeaders:["X-Request-Id",queued.id],contentType:"application/json",postBody:postBody,asynchronous:(Object.isFunction(queued.callback))?true:false};if(params.asynchronous){params.onComplete=function(transport){Kayjax.response(transport,function(json){return eval("("+json.unfilterJSON()+")")})}}req=new Ajax.Request(Kayjax.appendQuery(Kayjax.resolveUrl(url),options.query),params);if(!params.asynchronous){return Kayjax.response(new Ajax.Response(req))}}},update:function(j,f,g){if(Kayjax.requests.length>=Kayjax.maxCount){setTimeout(Kayjax.requests.curry(j,f,g),100)}else{Kayjax.fireStartEvents();g=g||{};var h,i;h={id:Kayjax.requests.length,callback:g.callback||null};Kayjax.requests.push(h);i={requestHeaders:["X-Request-Id",h.id],asynchronous:true,postBody:g.postBody,onComplete:function(a){Kayjax.updateResponse(a,j)}};new Ajax.Request(Kayjax.appendQuery(Kayjax.resolveUrl(f),g.query),i)}}});